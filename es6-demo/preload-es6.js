var Preload=function(e){"use strict";this.opts={sources:null,progress:function(){},connector:null,completeLoad:function(){},config:{timeOut:e.loadingOverTime||15,timeOutCB:e.loadingOverTimeCB||function(){}}},this.params={echetotal:0,echelon:[],echelonlen:[],echeloncb:[],id:0,flag:0,allowType:["jpg","jpeg","png","gif"],total:0,completedCount:0,_createXHR:null,imgNode:[],imgNodePSrc:[],audioNode:[],audioNodePSrc:[],head:document.getElementsByTagName("head")[0]};for(var t in e)this.opts[t]=e[t];this._init()};Preload.prototype={_init:function(){var e=this,t=e.opts,o=e.params;e._initData(),null!==t.connector&&e._getData(),e._load(o.echelon[0],o.echeloncb[0],o.echelonlen)},_initData:function(){var e=this,t=e.opts,o=e.params;if(null!==t.sources){o.echetotal=Object.getOwnPropertyNames(t.sources).length;for(var a in t.sources){for(var n=0,r=t.sources[a].source.length;r>n;n++)o.echelon.push(t.sources[a].source[n]);o.echelonlen.push(t.sources[a].source.length),o.echeloncb.push("undefined"==typeof t.sources[a].callback?null:t.sources[a].callback)}o._createXHR=e.getXHR();for(var a=1,r=o.echelonlen.length;r>a;a++)o.echelonlen[a]=o.echelonlen[a-1]+o.echelonlen[a];o.total=o.echelon.length,o.imgNode=document.getElementsByTagName("img");for(var a=0,r=o.imgNode.length;r>a;a++)o.imgNode[a].attributes.pSrc&&(o.imgNodePSrc[a]=o.imgNode[a].attributes.pSrc.value);o.audioNode=document.getElementsByTagName("audio");for(var a=0,r=o.audioNode.length;r>a;a++)o.audioNode[a].attributes.pSrc&&(o.audioNodePSrc[a]=o.audioNode[a].attributes.pSrc.value)}},_load:function(e,t,o){var a=this,n=a.opts,r=a.params;if(r.id>=o[r.flag]&&(null!=r.echeloncb[r.flag]&&r.echeloncb[r.flag](),++r.flag),r.id>=r.total)return void n.completeLoad();if(a.isImg(e)){var c=new Image,l=setTimeout(function(){n.config.timeOutCB()},1e3*n.config.timeOut);c.src=e,c.onload=function(){clearTimeout(l),n.progress(++r.completedCount,r.total);for(var c=0,i=r.imgNodePSrc.length;i>c;c++)if(r.imgNodePSrc[c]==e){r.imgNode[c].src=r.imgNodePSrc[c];break}a._load(r.echelon[++r.id],t,o)},c.onerror=function(){n.progress(++completedCount,total),a._load(r.echelon[++r.id],t,o)}}else r._createXHR.onreadystatechange=function(){if(4==r._createXHR.readyState){if(r._createXHR.status>=200&&r._createXHR.status<300||304===r._createXHR.status){n.progress(++r.completedCount,r.total);for(var c=0,l=r.audioNodePSrc.length;l>c;c++)if(r.audioNodePSrc[c]==e){r.audioNode[c].src=r.audioNodePSrc[c];break}a._load(r.echelon[++r.id],t,o)}}else r._createXHR.status>=400&&r._createXHR.status<500&&(n.progress(++r.completedCount,r.total),a._load(r.echelon[++r.id],t,o))},r._createXHR.open("GET",e,!0),r._createXHR.send(null)},_getData:function(){var e=this,t=e.opts;e.params;for(var o in t.connector)t.connector[o].jsonp?e.asynGetData(t.connector[o].url):e.syncGetData(t.connector[o].url,t.connector[o].callback)},syncGetData:function(e,t){var o=this,a=(o.opts,o.params);a._createXHR.onreadystatechange=function(){4==a._createXHR.readyState&&(a._createXHR.status>=200&&a._createXHR.status<300||304===a._createXHR.status)&&t(a._createXHR.responseText)},a._createXHR.open("GET",e,!0),a._createXHR.send(null)},asynGetData:function(e){var t=this,o=(t.opts,t.params),a=document.createElement("script");a.src=e,o.head.appendChild(a)},getXHR:function(){if("undefined"!=typeof XMLHttpRequest)return new XMLHttpRequest;if("undefined"!=typeof ActiveXObject){if("string"!=typeof arguments.callee.activeXString){var e,t,o=["MSXML2.XMLHttp.6.0","MSXML2.XMLHttp.3.0","MSXML2.XMLHttp"];for(e=0,t=o.length;t>e;e++)try{new ActiveXObject(o[e]),arguments.callee.activeXString=o[e];break}catch(a){}}return new ActiveXObject(arguments.callee.activeXString)}throw new Error("No XHR object available.")},isImg:function(e){for(var t=this,o=(t.opts,t.params),a=e.split(".").pop(),n=0,r=o.allowType.length;r>n;n++)if(a==o.allowType[n])return!0;return!1}},"object"==typeof module?module.exports=Preload:window.Preload=Preload;